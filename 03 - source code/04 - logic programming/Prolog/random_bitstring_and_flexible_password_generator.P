/*
random_bitstring_and_flexible_password_generator.P
(file extension .P is only there to distinguish this program from a Perl script with extension .pl)

A program for SWI Prolog: https://www.swi-prolog.org/

*** This program most probably won't work in any other Prolog system than SWI! ***


2025-11-19/20/21, 2025-12-01: have small hex letters a...f

run program in Ubuntu 24 LTS: $ swipl random_bitstring_and_flexible_password_generator.P
                              NN ?- random_bitstring_and_flexible_password_generator.  % enter this goal inside the SWI REPL
                              $

build program in Ubuntu 24 LTS:
  $ swipl -o random_bitstring_and_flexible_password_generator -g random_bitstring_and_flexible_password_generator -c random_bitstring_and_flexible_password_generator.P --stand_alone=true

run compiled program: $ ./random_bitstring_and_flexible_password_generator


$ swipl --version
SWI-Prolog version 9.3.34 for x86_64-linux
$

*/


%-----------------------------------------------------------------------------%
%
% user defined functions

% Check if a character is a digit
is_digit(Char) :- char_type(Char, digit).
% Check if a string (or atom) contains only digits
digits(String) :- atom_chars(String, Chars), maplist(is_digit, Chars).

input_a_valid_number(NCharDefault, NChar) :-
    format("\nPassword of ~w printable chars OK? 'y' or another integer number >= 8: ", NCharDefault),
    read_line_to_string(user_input, Answer),
    (Answer == "y" ->
         NChar is NCharDefault
         ;
         (digits(Answer), number_string(NChar,Answer),
          % format("input_a_valid_number: NChar = ~w", NChar),  % for testing
          % '10 10' is a valid answer here as integer 1010 !!
          % my fix: no white spaces allowed here at all with: digits(Answer)

          integer(NChar), NChar >= 8 ->
              % write("\ninput_a_valid_number: valid integer number entered.")  % for testing
              !  % cut operator to finish this predicate
              ;
              write("enter an integer number >= 8 or 'y'\n"),
              input_a_valid_number(NCharDefault, NChar)
         )
    ).


answer_yes_or_no(WithSpecialChars) :-
    format("\nDo you want me to use special characters like .;,+*... ? 'y' or 'n': "),
    read_line_to_string(user_input, Answer),
    (Answer == "y" ->
         WithSpecialChars = true  % unification with '=' symbol; finding the most general solution,
                                  % which is then the most general unification
         ;
         WithSpecialChars = false
    ).


% MS Bing AI answer on prompt: "Prolog build a string from a range of Code Points"
% build_cp_string(+Start, +End, -String)
% Creates a string from Unicode code points in the range [Start..End]
build_cp_string(Start, End, String) :-
    numlist(Start, End, Codes),         % Step 1: list of integers
    maplist(char_code, Chars, Codes),   % Step 2: convert to characters
    atom_chars(Atom, Chars),            % Step 3: build atom
    atom_string(Atom, String).          % Step 4: convert to string


% based on MS Bing AI prompt: "SWI Prolog predicate to write a string to a file, including error handling"
write_to_file(FileName, Content, FileType) :-
    % must_be(atom, FileName),   % Ensure FileName is an atom (string-like)
    % must_be(string, Content),  % Ensure Content is a Prolog string
    catch(
        (setup_call_cleanup(
             open(FileName, write, Stream, [encoding(utf8)]),  % Open file for writing
                 (write(Stream, Content),                      % Write the string
                  flush_output(Stream)
                 ),
             close(Stream)                                     % Always close the file
             ),
             % if-then-else
             FileType == "bit" ->
                 format("\nBit stream has been written to disk under name:  ~w", [FileName]),
                 flush_output  % force the text to appear immediately
                 ;
                 format("\nByte stream has been written to disk under name: ~w", [FileName]),
                 flush_output
        ),

        Error,

        (format(user_error, "\ncould not write to file: ~w -- ~w", [FileName, Error]),
         flush_output)
    ).


% MS Bing AI prompt: "Prolog convert a string of base 2 into a decimal number"
% bin_string_to_integer(+BinString, -Decimal)
% Convert a binary string into its decimal value.
bin_string_to_integer(BinString, Decimal) :-
    string_chars(BinString, Chars),          % split string into list of '0'/'1'
    maplist(atom_number, Chars, Digits),     % convert each char to number
    binary_list_decimal(Digits, Decimal).

% helper: compute decimal from list of bits
binary_list_decimal(Digits, Decimal) :-
    reverse(Digits, Rev),                    % reverse for positional weights
    binary_list_decimal(Rev, 0, 0, Decimal).

binary_list_decimal([], _, Acc, Acc).
binary_list_decimal([Bit|Rest], Pos, Acc, Decimal) :-
    Value is Bit * (2^Pos),
    NewAcc is Acc + Value,
    NextPos is Pos + 1,
    binary_list_decimal(Rest, NextPos, NewAcc, Decimal).



%********************  recursive password creation  ************************%
%
% 3 x input, 1 x output:
pw_generator(0, _, _, []).  % Base case
pw_generator(NChar, [FirstRandNbr|RestX], CharSet, [CharAddList|Password]) :-
    NChar > 0,

    % format("\n\nFirstRandNbr = ~w", FirstRandNbr),  % for testing
    format(atom(Bin0),"~|~`0t~2r~16+",[FirstRandNbr]),
    % format("\nBin0 = ~w", Bin0),  % for testing

    sub_string(Bin0, 0, 8, 8, Bin0_0),
    sub_string(Bin0, 8, 8, 0, Bin0_1),
    % format("\nBin0_0 = ~w", Bin0_0),  % for testing
    % format("\nBin0_1 = ~w", Bin0_1),  % for testing

    bin_string_to_integer(Bin0_0, Char0),
    bin_string_to_integer(Bin0_1, Char1),
    % format("\nChar0 = ~w", Char0),  % for testing
    % format("\nChar1 = ~w", Char1),  % for testing

    char_code(Char0a, Char0),  % Char0a is of type atom
    char_code(Char1a, Char1),
    % format("\nChar0a = ~w", Char0a),  % for testing
    % format("\nChar1a = ~w", Char1a),  % for testing

    (sub_string(CharSet, _, 1, _, Char0a) ->
        Char0_add = Char0a,
        Char0_nbr_add = 1
        ;
        Char0_add = '',
        Char0_nbr_add = 0
    ),
    (sub_string(CharSet, _, 1, _, Char1a), NChar > Char0_nbr_add ->
        Char1_add = Char1a,
        Char1_nbr_add = 1
        ;
        Char1_add = '',
        Char1_nbr_add = 0
    ),

    atom_concat(Char0_add, Char1_add, Char_add),  % Char_add is of type atom
    % format("\nChar_add = ~w", Char_add),  % for testing
    CharAddList = Char_add,

    NewNChar is NChar - Char0_nbr_add - Char1_nbr_add,  % decrement counter
    pw_generator(NewNChar, RestX, CharSet, Password).  % recursion

% end of password creation
%***************************************************************************%


%**********************  recursive master loop  ****************************%
%
masterloop(0, _, [], [], []).  % Base case: counter has reached 0
                               % have only the empty list as last list elements!!
                               % lists are running in sync here:
                               %   X       = [17150,65176,37352,53270,20323,57987,25061,34243,57898,52169]
                               %   BitsHex = [42FE,FE98,91E8,D016,4F63,E283,61E5,85C3,E22A,CBC9]
masterloop(Length, Seed, [NewSeed|RestX], [BitsX|RestBitsX], [BitsHex|RestBitsHex]) :-
                               % [|] is the non-empty list constructor, pronounced "cons"
  Length > 0,
  % write("\nLength = "), write(Length),  % for testing

  NewSeed is (17364 * Seed + 0) mod 65521,  % 'is' is the infix operator to evaluate an arithmetic expression;
                                            % same situation for global constants as in Mercury,
                                            % which are not available so easily.
                                            % But I'm not playing around in Prolog with functor() and arg() to
                                            % implement global constanta here.
  % write("\n  NewSeed = "), write(NewSeed),  % for testing

  format(atom(BitsX),"~|~`0t~2r~16+",[NewSeed]),    % NewSeed = 10120 => BitsX = 0010011110001000
                                                    % https://www.swi-prolog.org/pldoc/man?predicate=format/2
  % write("\n  BitsX = "), write(BitsX),  % for testing

  format(atom(BitsHex0),"~|~`0t~16R~4+",[NewSeed]),  % NewSeed = 10120 => BitsHex = 2788: bad example, was hiding capital letter output!
  downcase_atom(BitsHex0, BitsHex),                  % correct result now: 101244c6d74f524d95e5647bf63c7....
  % write("\n  BitsHex = "), write(BitsHex),  % for testing

  NewLength is Length - 1,  % decrement counter
  masterloop(NewLength, NewSeed, RestX, RestBitsX, RestBitsHex).  % recursion

% end of masterloop
%***************************************************************************%

% end of user defined functions
%
%-----------------------------------------------------------------------------%


random_bitstring_and_flexible_password_generator :-

    End = 62500,  % 62500 for exactly 1M binary digits
    % End = 25,     % for testing

    M = 65521,      % = 2^16 - 15

    FileBitsX   = 'random_bitstring.bin',  % this must be an atom with '', not string with ""
    FileBitsHex = 'random_bitstring.byte',

    random_between(1, M, X0),
    % write("\nX0 = "), write(X0),  % for testing

    write("\ngenerating a random bit stream..."),

    % masterloop(End, X0, X, _, _),  % 2 x input, 3 x output; for testing
    masterloop(End, X0, X, BitsX, BitsHex),  % 2 x input, 3 x output
    % write("\n\nX = "), write(X),  % for testing
    % write("\n\nBitsX = "), write(BitsX),  % for testing
    % write("\n\nBitsHex = "), write(BitsHex),  % for testing

    % convert lists of strings into big strings:
    maplist(atom_string, AtomsX, BitsX),
    atomic_list_concat(AtomsX, AtomResultX),
    % MS Bing AI:
    %   The fastest idiomatic way is to use atomic_list_concat/2 (or /3 if you need a separator).
    %   It works directly on a list of strings/atoms and builds the result in one pass.
    atom_string(AtomResultX, BitsXStr),
    % format("\nBitsXStr = ~w", [BitsXStr]),  % for testing

    maplist(atom_string, AtomsHex, BitsHex),
    atomic_list_concat(AtomsHex, AtomResultHex),
    atom_string(AtomResultHex, BitsHexStr),
    % format("\nBitsHexStr = ~w", [BitsHexStr]),  % for testing

    write_to_file(FileBitsX, BitsXStr, "bit"),
    write_to_file(FileBitsHex, BitsHexStr, "byte"),
    write('\n'),

    NCharDefault is 12,
    input_a_valid_number(NCharDefault, NChar),
    % format("\nNChar = ~w", NChar),  % for testing

    answer_yes_or_no(WithSpecialChars),  % WithSpecialChars is: true or false
    % format("\nWithSpecialChars = ~w", WithSpecialChars),  % for testing

    (WithSpecialChars ->
         build_cp_string(33, 126, CharSet)  % 126 is inclusive
         ;
         build_cp_string(48, 57, CharSet1),
         build_cp_string(65, 90, CharSet2),
         build_cp_string(97, 122, CharSet3),
         string_concat(CharSet1, CharSet2, CharSet2a),
         string_concat(CharSet2a, CharSet3, CharSet)

    ),
    % format("\nCharSet = ~w", CharSet),  % for testing

    pw_generator(NChar, X, CharSet, PasswordList),  % 3 x input, 1 x output

    % flatten this list of atoms:
    atomics_to_string(PasswordList, Password),

    format("\nYour password of ~w characters is: ~w", [NChar, Password]),

    write('\n'),
    halt(0).

% end of random_bitstring_and_flexible_password_generator.P
